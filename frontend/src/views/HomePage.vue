<template>
  <div class="min-h-screen bg-gradient-to-br from-ocean-50 via-white to-sea-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">
    <!-- ÂØºËà™Ê†è -->
    <nav class="sticky top-0 z-30 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- LogoÂíåÂçö‰∏ª‰ø°ÊÅØ -->
          <div class="flex items-center space-x-4">
            <img 
              v-lazy-img="'/avatar.jpg'"
              alt="ÈúúÈõ™ÊóßÊõæË∞ô"
              class="w-10 h-10 rounded-full border-2 border-ocean-200 dark:border-ocean-700"
            />
            <div>
              <h1 class="text-xl font-bold text-gradient">ÈúúÈõ™ÊóßÊõæË∞ô</h1>
              <p class="text-xs text-gray-500 dark:text-gray-400">‰∏™‰∫∫ÂçöÂÆ¢</p>
            </div>
          </div>
          
          <!-- ÂØºËà™ËèúÂçï -->
          <div class="hidden md:flex items-center space-x-8">
            <router-link 
              to="/home" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              È¶ñÈ°µ
            </router-link>
            <router-link 
              to="/archive" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              ÂΩíÊ°£
            </router-link>
            <router-link 
              to="/category" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              ÂàÜÁ±ª
            </router-link>
            <router-link 
              to="/tag" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              Ê†áÁ≠æ
            </router-link>
            <router-link 
              to="/about" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              ÂÖ≥‰∫é
            </router-link>
            <router-link 
              v-if="isAuthenticated"
              to="/audio-library" 
              class="text-gray-700 dark:text-gray-300 hover:text-ocean-600 dark:hover:text-ocean-400 transition-colors"
              active-class="text-ocean-600 dark:text-ocean-400"
            >
              üéµ Èü≥È¢ëÂ∫ì
            </router-link>

          </div>

          <!-- ÁÆ°ÁêÜÂëòÊ¨¢Ëøé‰∏éÂø´Êç∑ÂÖ•Âè£ -->
          <div v-if="isAuthenticated" class="hidden md:flex items-center space-x-3">
            <span class="text-sm text-gray-600 dark:text-gray-300">Ê¨¢ËøéÔºå{{ adminName }}</span>
            <router-link
              to="/admin/posts/new"
              class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-ocean-600 text-white hover:bg-ocean-700"
              title="Êñ∞Âª∫ÊñáÁ´†"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </router-link>
          </div>
        </div>
      </div>
    </nav>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Â∑¶‰æßÊñáÁ´†ÂàóË°® -->
        <div class="lg:col-span-3">
          <!-- ÊêúÁ¥¢Ê†è -->
          <div class="mb-8">
            <div class="relative">
              <input
                v-model="searchQuery"
                type="text"
                placeholder="ÊêúÁ¥¢ÊñáÁ´†..."
                @input="onSearchInput"
                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-ocean-500 focus:border-transparent transition-all"
              />
              <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>

          <!-- ÊñáÁ´†ÂàóË°® -->
          <div class="space-y-6">
            <article 
              v-for="post in filteredPosts" 
              :key="post.id"
              class="card hover:shadow-xl transition-all duration-300 group"
            >
              <!-- Â∞ÅÈù¢ÂõæÔºàÊúâÂàôÊòæÁ§∫ÔºâÔºåÊáíÂä†ËΩΩÔºå‰øùÊåÅÊØî‰æãÈÅøÂÖçÂ∏ÉÂ±ÄÊäñÂä® -->
              <div v-if="post.cover_url" class="w-full overflow-hidden rounded-t-xl">
                <div class="relative w-full" style="aspect-ratio: 16/9;">
                  <img
                    v-lazy-img="getCoverSrc(post.cover_url)"
                    :alt="post.title || 'ÊñáÁ´†Â∞ÅÈù¢'"
                    class="absolute inset-0 w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-105 bg-gray-200 dark:bg-gray-700"
                    @error="onCoverError($event)"
                  />
                </div>
              </div>

              <div class="p-6">
                <!-- ÊñáÁ´†Ê†áÈ¢ò -->
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3 group-hover:text-ocean-600 dark:group-hover:text-ocean-400 transition-colors">
                  <router-link :to="`/post/${post.slug}`">
                    {{ post.title }}
                  </router-link>
                </h2>
                
                <!-- ÊñáÁ´†ÊëòË¶Å -->
                <p class="text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">
                  {{ post.excerpt }}
                </p>
                
                <!-- ÊñáÁ´†ÂÖÉ‰ø°ÊÅØ -->
                <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                  <div class="flex items-center space-x-4">
                    <span class="flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      {{ formatDate(post.published_at || post.created_at) }}
                    </span>
                    <span class="flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {{ post.read_time }} ÂàÜÈíüÈòÖËØª
                    </span>
                  </div>
                  
                  <!-- ÂàÜÁ±ªÊ†áÁ≠æ -->
                  <span class="px-3 py-1 bg-ocean-100 dark:bg-ocean-900/30 text-ocean-800 dark:text-ocean-200 rounded-full text-xs font-medium">
                    {{ post.category }}
                  </span>
                </div>
                
                <!-- Ê†áÁ≠æ -->
                <div class="mt-4 flex flex-wrap gap-2">
                  <span 
                    v-for="tag in post.tags" 
                    :key="tag"
                    @click="setCurrentTag(tag)"
                    class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md text-xs cursor-pointer hover:bg-ocean-100 dark:hover:bg-ocean-900/30 hover:text-ocean-700 dark:hover:text-ocean-300 transition-colors"
                  >
                    #{{ tag }}
                  </span>
                </div>
              </div>
            </article>
            
            <!-- Êó†ÊñáÁ´†ÊèêÁ§∫ -->
            <div v-if="filteredPosts.length === 0" class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">ÊöÇÊó†ÊñáÁ´†</h3>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Â∞ùËØïË∞ÉÊï¥ÊêúÁ¥¢Êù°‰ª∂ÊàñÂàÜÁ±ªÁ≠õÈÄâ</p>
            </div>
          </div>
        </div>

        <!-- Âè≥‰æßËæπÊ†è -->
        <div class="lg:col-span-1">
          <!-- ÂàÜÁ±ª -->
          <div class="card mb-6">
            <div class="p-6">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">ÂàÜÁ±ª</h3>
              <div class="space-y-2">
                <button
                  v-for="category in categories"
                  :key="category.name"
                  @click="setCurrentCategory(category.name)"
                  :class="[
                    'w-full text-left px-3 py-2 rounded-lg transition-colors',
                    currentCategory === category.name
                      ? 'bg-ocean-100 dark:bg-ocean-900/30 text-ocean-800 dark:text-ocean-200'
                      : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                  ]"
                >
                  <span class="flex justify-between items-center">
                    {{ category.name }}
                    <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded-full">
                      {{ category.count }}
                    </span>
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- Ê†áÁ≠æ‰∫ë -->
          <div class="card mb-6">
            <div class="p-6">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Ê†áÁ≠æ</h3>
              <div class="flex flex-wrap gap-2">
                <button
                  v-for="tag in tags"
                  :key="tag.name"
                  @click="setCurrentTag(tag.name)"
                  :class="[
                    'px-3 py-1 rounded-full text-sm transition-colors',
                    currentTag === tag.name
                      ? 'bg-ocean-600 text-white'
                      : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-ocean-100 dark:hover:bg-ocean-900/30'
                  ]"
                >
                  {{ tag.name }}
                </button>
              </div>
            </div>
          </div>

          <!-- Ê∏ÖÈô§Á≠õÈÄâ -->
          <div v-if="currentCategory || currentTag || searchQuery" class="card">
            <div class="p-6">
              <button
                @click="clearFilters()"
                class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
              >
                Ê∏ÖÈô§Á≠õÈÄâ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

interface PublishedPost {
  id: number
  title: string
  slug: string
  excerpt: string
  category?: string
  tags: string[]
  cover_url?: string
  read_time: number
  published_at?: string
  created_at: string
}

interface Category {
  name: string
  count: number
}

interface Tag {
  name: string
  count: number
}

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchQuery = ref('')
const currentCategory = ref('')
const currentTag = ref('')
const loading = ref(false)
const error = ref<string | null>(null)

const posts = ref<PublishedPost[]>([])
const categories = ref<Category[]>([])
const tags = ref<Tag[]>([])

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredPosts = computed(() => {
  let filtered = posts.value

  if (currentCategory.value) {
    filtered = filtered.filter(post => post.category === currentCategory.value)
  }

  if (currentTag.value) {
    filtered = filtered.filter(post => post.tags.includes(currentTag.value))
  }

  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    filtered = filtered.filter(post => 
      post.title.toLowerCase().includes(query) || 
      post.excerpt.toLowerCase().includes(query)
    )
  }

  return filtered
})

// ÊñπÊ≥ï
const setCurrentCategory = (category: string) => {
  currentCategory.value = currentCategory.value === category ? '' : category
  updateURL()
}

const setCurrentTag = (tag: string) => {
  currentTag.value = currentTag.value === tag ? '' : tag
  updateURL()
}

const clearFilters = () => {
  currentCategory.value = ''
  currentTag.value = ''
  searchQuery.value = ''
  updateURL()
}

const updateURL = () => {
  const url = new URL(window.location.href)
  const params = new URLSearchParams()
  
  if (currentCategory.value) {
    params.set('category', currentCategory.value)
  }
  if (currentTag.value) {
    params.set('tag', currentTag.value)
  }
  
  if (params.toString()) {
    url.search = params.toString()
  } else {
    url.search = ''
  }
  
  window.history.replaceState({}, '', url.toString())
}

const onSearchInput = () => {
  // ÊêúÁ¥¢ÂäüËÉΩ‰∏çÈúÄË¶ÅÊõ¥Êñ∞ URLÔºåÂõ†‰∏∫ÊêúÁ¥¢ÊòØÂÆûÊó∂ÁöÑ
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Èò≤ÊäñÂäüËÉΩ
}

const formatDate = (dateString: string) => {
  const date = new Date(dateString)
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

// Â∞ÅÈù¢Âú∞ÂùÄËΩ¨Êç¢ÔºàÂèØÂú®Ê≠§Â§ÑÁêÜ CDN„ÄÅÂç†‰ΩçÂõæÁ≠âÔºâ
const getCoverSrc = (src?: string) => {
  if (!src) return ''
  try {
    // Â¶ÇÊûúÊòØÁªùÂØπË∑ØÂæÑÊàñ http(s)ÔºåÁõ¥Êé•ËøîÂõû
    if (/^https?:\/\//i.test(src) || src.startsWith('/')) return src
    // Âê¶ÂàôÊåâÊúçÂä°Âô®ËøîÂõûÁöÑÁõ∏ÂØπË∑ØÂæÑÂ§ÑÁêÜ
    return `/${src.replace(/^\/+/, '')}`
  } catch {
    return src
  }
}

// Â∞ÅÈù¢Âä†ËΩΩÂ§±Ë¥•Â§ÑÁêÜÔºöÈÄÄÂõûÂç†‰ΩçËÉåÊôØ
const onCoverError = (e: Event) => {
  const target = e.target as HTMLImageElement
  target.style.objectFit = 'contain'
  target.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='450'>
      <defs>
        <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop stop-color='#e5e7eb' offset='0%'/>
          <stop stop-color='#d1d5db' offset='100%'/>
        </linearGradient>
      </defs>
      <rect width='100%' height='100%' fill='url(#g)'/>
    </svg>`
  )
}

// API Ë∞ÉÁî®
const fetchPublishedPosts = async () => {
  try {
    loading.value = true
    error.value = null
    
    const { http } = await import('../utils/http')
    const result = await http.get<any>('/posts/published')
    
    if (result.success) {
      posts.value = result.data.items
    } else {
      error.value = result.message || 'Ëé∑ÂèñÊñáÁ´†Â§±Ë¥•'
    }
  } catch (err) {
    console.error('Ëé∑ÂèñÊñáÁ´†Â§±Ë¥•:', err)
    error.value = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'
  } finally {
    loading.value = false
  }
}

const fetchPublishedCategories = async () => {
  try {
    const { http } = await import('../utils/http')
    const result = await http.get<any>('/categories/published')
    
    if (result.success) {
      categories.value = result.data
    }
  } catch (err) {
    console.error('Ëé∑ÂèñÂàÜÁ±ªÂ§±Ë¥•:', err)
  }
}

const fetchPublishedTags = async () => {
  try {
    const { http } = await import('../utils/http')
    const result = await http.get<any>('/tags/published')
    
    if (result.success) {
      tags.value = result.data
    }
  } catch (err) {
    console.error('Ëé∑ÂèñÊ†áÁ≠æÂ§±Ë¥•:', err)
  }
}

onMounted(async () => {
  await Promise.all([
    fetchPublishedPosts(),
    fetchPublishedCategories(),
    fetchPublishedTags()
  ])
  
  // Ê£ÄÊü• URL Êü•ËØ¢ÂèÇÊï∞
  const urlParams = new URLSearchParams(window.location.search)
  const categoryParam = urlParams.get('category')
  const tagParam = urlParams.get('tag')
  
  if (categoryParam) {
    currentCategory.value = categoryParam
  }
  if (tagParam) {
    currentTag.value = tagParam
  }
})


// ÁÆ°ÁêÜÂëòÊ¨¢ËøéÊèêÁ§∫ÈÄªËæë
const isAuthenticated = computed(() => !!localStorage.getItem('access_token'))
const adminName = computed(() => {
  try {
    const raw = localStorage.getItem('auth_user')
    if (!raw) return 'ÁÆ°ÁêÜÂëò'
    const u = JSON.parse(raw)
    return u?.username || 'ÁÆ°ÁêÜÂëò'
  } catch {
    return 'ÁÆ°ÁêÜÂëò'
  }
})
</script>
